#!/bin/bash

# liar update script for .liar_software
#
# To be called in crontab:
#
# 45 7 * * Tue,Fri ~/Sources/liar-update-software/liar-update-software ~/Sources/liar/
LIAR_SOFTWARE_FILE=liar-software

# Make sure Maven and Java are in the crontab environment
export JAVA_HOME=/usr/lib/jvm/jdk8/jdk1.8.0_231
PATH=~/bin:${JAVA_HOME}/bin:${PATH}

export GRAALVM_HOME=/usr/lib/jvm/graalvm/graalvm-ce-java8-20.1.0/

liar_update_repository=$(dirname "$0")
liar_repository="$1"
exec > "${liar_update_repository}/output.log" 2>&1

# debug
java -version
which java
mvn -version
echo "PATH=${PATH}"
echo "JAVA_HOME=${JAVA_HOME}"

cd "${liar_update_repository}"

# Build native image
if [ ! -f  "./target/SoftwareUpdateRepository.native" ]; then
    make LIAR_REPOSITORY="${liar_repository}" install_native
fi

# Run update
make LIAR_REPOSITORY="${liar_repository}" update_native

# Update repository
cd "${liar_repository}"
git pull
if git status --porcelain ${LIAR_SOFTWARE_FILE} | grep ${LIAR_SOFTWARE_FILE}; then
    git add ${LIAR_SOFTWARE_FILE}
    git commit -m"Automatic URL update"
    git push
fi
